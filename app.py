import streamlit as st
from groq import Groq

# --- рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў рЃЊрЃљ рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ ---
client = Groq(api_key="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")

st.set_page_config(page_title="Gemo AI Pro", page_icon="­ЪДњ")

# --- рЃњрЃарЃФрЃћрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃћрЃЉрЃўрЃА рЃЉрЃџрЃЮрЃЎрЃў ---
INFO_PRESIDENTS = """
### ­ЪЄг­ЪЄф рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃА рЃърЃарЃћрЃќрЃўрЃЊрЃћрЃюрЃбрЃћрЃЉрЃў:

1. **рЃќрЃЋрЃўрЃљрЃЊ рЃњрЃљрЃЏрЃАрЃљрЃ«рЃБрЃарЃЊрЃўрЃљ (1991РђЊ1992):** рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃърЃарЃћрЃќрЃўрЃЊрЃћрЃюрЃбрЃў, рЃЊрЃљрЃЏрЃЮрЃБрЃЎрЃўрЃЊрЃћрЃЉрЃџрЃЮрЃЉрЃўрЃА рЃљрЃдрЃЊрЃњрЃћрЃюрЃўрЃА рЃАрЃўрЃЏрЃЉрЃЮрЃџрЃЮ.
2. **рЃћрЃЊрЃБрЃљрЃарЃЊ рЃерЃћрЃЋрЃљрЃарЃЊрЃюрЃљрЃФрЃћ (1995РђЊ2003):** рЃЊрЃљрЃАрЃљрЃЋрЃџрЃБрЃарЃў рЃЎрЃБрЃарЃАрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ рЃЊрЃљ 1995 рЃгрЃџрЃўрЃА рЃЎрЃЮрЃюрЃАрЃбрЃўрЃбрЃБрЃфрЃўрЃљ.
3. **рЃЏрЃўрЃ«рЃћрЃўрЃџ рЃАрЃљрЃљрЃЎрЃљрЃерЃЋрЃўрЃџрЃў (2004РђЊ2013):** рЃЋрЃљрЃарЃЊрЃћрЃЉрЃўрЃА рЃарЃћрЃЋрЃЮрЃџрЃБрЃфрЃўрЃўрЃА рЃџрЃўрЃЊрЃћрЃарЃў, рЃАрЃљрЃ«рЃћрЃџрЃЏрЃгрЃўрЃцрЃЮ рЃўрЃюрЃАрЃбрЃўрЃбрЃБрЃбрЃћрЃЉрЃўрЃА рЃарЃћрЃцрЃЮрЃарЃЏрЃљ.
4. **рЃњрЃўрЃЮрЃарЃњрЃў рЃЏрЃљрЃарЃњрЃЋрЃћрЃџрЃљрЃерЃЋрЃўрЃџрЃў (2013РђЊ2018):** рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃърЃарЃћрЃќрЃўрЃЊрЃћрЃюрЃбрЃў рЃАрЃљрЃърЃљрЃарЃџрЃљрЃЏрЃћрЃюрЃбрЃЮ рЃарЃћрЃАрЃърЃБрЃЉрЃџрЃўрЃЎрЃўрЃА рЃЏрЃЮрЃЊрЃћрЃџрЃерЃў.
5. **рЃАрЃљрЃџрЃЮрЃЏрЃћ рЃќрЃБрЃарЃљрЃЉрЃўрЃерЃЋрЃўрЃџрЃў (2018РђЊрЃЊрЃдрЃћрЃЏрЃЊрЃћ):** рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЦрЃљрЃџрЃў рЃърЃарЃћрЃќрЃўрЃЊрЃћрЃюрЃбрЃў рЃАрЃљрЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃЮрЃерЃў.
"""

# --- рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ рЃњрЃљрЃЏрЃарЃљрЃЋрЃџрЃћрЃЉрЃўрЃА рЃбрЃљрЃЉрЃБрЃџрЃўрЃА рЃњрЃћрЃюрЃћрЃарЃўрЃарЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА ---
def generate_multiplication_table(number):
    table = f"### ­Ъћб {number}-рЃўрЃА рЃњрЃљрЃЏрЃарЃљрЃЋрЃџрЃћрЃЉрЃўрЃА рЃбрЃљрЃЉрЃБрЃџрЃљ:\n\n"
    table += "| рЃцрЃЮрЃарЃЏрЃБрЃџрЃљ | рЃерЃћрЃЊрЃћрЃњрЃў |\n| :--- | :--- |\n"
    for i in range(1, 11):
        table += f"| {number} ├Ќ {i} | **{number * i}** |\n"
    return table

# --- рЃърЃћрЃарЃАрЃЮрЃюрЃљрЃџрЃБрЃарЃў рЃърЃљрЃАрЃБрЃ«рЃћрЃЉрЃўрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ ---
def get_custom_response(text):
    text = text.lower().strip()
    
    # 1. рЃЋрЃљрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃЌ, рЃ«рЃЮрЃЏ рЃљрЃа рЃўрЃЌрЃ«рЃЮрЃЋрЃА рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃў рЃњрЃљрЃЏрЃарЃљрЃЋрЃџрЃћрЃЉрЃўрЃА рЃбрЃљрЃЉрЃБрЃџрЃљрЃА
    if "рЃбрЃљрЃЉрЃБрЃџрЃљ" in text or "рЃњрЃљрЃЏрЃарЃљрЃЋрЃџрЃћрЃЉрЃљ" in text:
        words = text.split()
        for word in words:
            if word.isdigit(): # рЃЌрЃБ рЃгрЃўрЃюрЃљрЃЊрЃљрЃЊрЃћрЃЉрЃљрЃерЃў рЃфрЃўрЃцрЃарЃў рЃўрЃърЃЮрЃЋрЃљ
                return generate_multiplication_table(int(word))

    # 2. рЃАрЃбрЃљрЃбрЃўрЃЎрЃБрЃарЃў рЃърЃљрЃАрЃБрЃ«рЃћрЃЉрЃўрЃА рЃџрЃћрЃЦрЃАрЃўрЃЎрЃЮрЃюрЃў
    responses = {
        "рЃњрЃљрЃЏрЃљрЃарЃ»рЃЮрЃЉрЃљ": "рЃАрЃљрЃџрЃљрЃЏрЃў!",
        "рЃЋрЃўрЃю рЃерЃћрЃњрЃЦрЃЏрЃюрЃљ": "рЃЏрЃћ рЃЊрЃћрЃЋрЃћрЃџрЃЮрЃърЃћрЃарЃЏрЃљ рЃерЃћрЃЏрЃЦрЃЏрЃюрЃљ.",
        "рЃарЃљ рЃњрЃЦрЃЋрЃўрЃљ": "рЃЏрЃћ рЃЏрЃЦрЃЋрЃўрЃљ Gemo AI.",
        "рЃарЃљрЃЏрЃЊрЃћрЃюрЃў рЃгрЃџрЃўрЃА рЃ«рЃљрЃа": "рЃЏрЃћ рЃ«рЃћрЃџрЃЮрЃЋрЃюрЃБрЃарЃў рЃўрЃюрЃбрЃћрЃџрЃћрЃЦрЃбрЃў рЃЋрЃљрЃа, рЃљрЃАрЃљрЃЎрЃў рЃљрЃа рЃЏрЃљрЃЦрЃЋрЃА!",
        "рЃюрЃљрЃ«рЃЋрЃљрЃЏрЃЊрЃўрЃА": "рЃюрЃљрЃ«рЃЋрЃљрЃЏрЃЊрЃўрЃА, рЃўрЃЏрЃћрЃЊрЃўрЃљ рЃЏрЃљрЃџрЃћ рЃўрЃАрЃћрЃЋ рЃЋрЃўрЃАрЃљрЃБрЃЉрЃарЃћрЃЉрЃЌ!",
        "рЃарЃЮрЃњрЃЮрЃа рЃ«рЃљрЃа": "рЃЎрЃљрЃарЃњрЃљрЃЊ рЃЋрЃљрЃа, рЃњрЃЏрЃљрЃЊрЃџрЃЮрЃЉ! рЃерЃћрЃю рЃарЃЮрЃњрЃЮрЃа рЃ«рЃљрЃа?",
        "рЃерЃћрЃЏрЃЦрЃЏрЃюрЃћрЃџрЃў": "рЃЏрЃўрЃ«рЃћрЃўрЃџ рЃГрЃўрЃГрЃўрЃљрЃерЃЋрЃўрЃџрЃўрЃљ рЃЕрЃћрЃЏрЃў рЃерЃћрЃЏрЃЦрЃЏрЃюрЃћрЃџрЃў рЃЊрЃљ рЃФрЃљрЃџрЃўрЃљрЃю рЃюрЃўрЃГрЃўрЃћрЃарЃў рЃЊрЃћрЃЋрЃћрЃџрЃЮрЃърЃћрЃарЃўрЃљ.",
        "рЃърЃарЃћрЃќрЃўрЃЊрЃћрЃюрЃб": INFO_PRESIDENTS,
        "рЃљрЃЏрЃЉрЃљрЃюрЃў": "рЃЦрЃљрЃарЃЌрЃБрЃџрЃў рЃљрЃЏрЃЉрЃљрЃюрЃў рЃЏрЃАрЃЮрЃцрЃџрЃўрЃЮрЃерЃў рЃћрЃарЃЌ-рЃћрЃарЃЌрЃў рЃБрЃюрЃўрЃЎрЃљрЃџрЃБрЃарЃўрЃљ рЃЊрЃљ рЃўрЃБрЃюрЃћрЃАрЃЎрЃЮрЃА рЃЏрЃћрЃЏрЃЎрЃЋрЃўрЃЊрЃарЃћрЃЮрЃЉрЃљрЃљ.",
        "рЃЌрЃЮрЃарЃюрЃўрЃЎрЃћ рЃ»рЃЮрЃ»рЃБрЃљ": "рЃЌрЃЮрЃарЃюрЃўрЃЎрЃћ рЃ»рЃЮрЃ»рЃБрЃљ рЃљрЃарЃўрЃА рЃЊрЃљрЃфрЃЋрЃўрЃА рЃЎрЃЮрЃЏрЃърЃљрЃюрЃўрЃљ РђърЃЏрЃљрЃњрЃўрЃАрЃбрЃарЃўрЃАРђю рЃЊрЃўрЃарЃћрЃЦрЃбрЃЮрЃарЃў."
    }

    # рЃЋрЃћрЃФрЃћрЃЉрЃЌ рЃАрЃљрЃЎрЃЋрЃљрЃюрЃФрЃЮ рЃАрЃўрЃбрЃДрЃЋрЃљрЃА
    for key in responses:
        if key in text:
            return responses[key]
    return None

# --- рЃ«рЃЏрЃўрЃА рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ (JavaScript) ---
st.markdown("""
    <script>
    function speakText(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ka-GE';
        msg.pitch = 1.1;
        window.speechSynthesis.speak(msg);
    }
    </script>
    """, unsafe_allow_html=True)

# рЃЏрЃћрЃ«рЃАрЃўрЃћрЃарЃћрЃЉрЃўрЃА рЃўрЃюрЃўрЃфрЃўрЃљрЃџрЃўрЃќрЃљрЃфрЃўрЃљ
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": "рЃерЃћрЃю рЃ«рЃљрЃа Gemo AI. рЃўрЃДрЃљрЃЋрЃў рЃЏрЃЮрЃЎрЃџрЃћ рЃЊрЃљ рЃќрЃБрЃАрЃбрЃў."}]

# рЃўрЃАрЃбрЃЮрЃарЃўрЃўрЃА рЃЕрЃЋрЃћрЃюрЃћрЃЉрЃљ
for message in st.session_state.messages:
    if message["role"] != "system":
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

# рЃЕрЃљрЃбрЃў
if prompt := st.chat_input("рЃ░рЃЎрЃўрЃЌрЃ«рЃћ рЃарЃљрЃЏрЃћ Gemo-рЃА..."):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        custom_answer = get_custom_response(prompt)
        
        if custom_answer:
            response = custom_answer
        else:
            try:
                completion = client.chat.completions.create(
                    model="llama-3.1-8b-instant",
                    messages=st.session_state.messages,
                    temperature=0.1,
                    max_tokens=400
                )
                response = completion.choices[0].message.content
            except Exception:
                response = "рЃБрЃЎрЃљрЃфрЃарЃљрЃЋрЃљрЃЊ, рЃ«рЃљрЃарЃЋрЃћрЃќрЃўрЃљ API-рЃАрЃЌрЃљрЃю рЃЎрЃљрЃЋрЃерЃўрЃарЃўрЃАрЃљрЃА."

        st.markdown(response)
        
        # рЃ«рЃЏрЃўрЃА рЃњрЃљрЃерЃЋрЃћрЃЉрЃљ
        clean_response = response.replace("'", "").replace("\n", " ").replace("#", "")
        st.components.v1.html(f"<script>speakText('{clean_response}');</script>", height=0)
        
        st.session_state.messages.append({"role": "assistant", "content": response})
